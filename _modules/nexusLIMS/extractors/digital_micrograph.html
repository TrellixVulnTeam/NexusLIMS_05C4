
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nexusLIMS.extractors.digital_micrograph &#8212; NexusLIMS 1.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom-styles.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/custom.js"></script>
    <link rel="shortcut icon" href="../../../_static/nexusLIMS_bare_logo.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html"><span><img src="../../../_static/logo_horizontal.png"></span>
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../api.html">API Docs</a></li>
                <li><a href="https://github.com/usnistgov/NexusLIMS">Repository</a></li>
                <li><a href="https://www.nist.gov/mml/odi">NIST ODI</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site Map <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../api/nexusLIMS.html">nexusLIMS package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.builder.html">nexusLIMS.builder package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.db.html">nexusLIMS.db package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.extractors.html">nexusLIMS.extractors package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.harvesters.html">nexusLIMS.harvesters package</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../api/nexusLIMS.schemas.html">nexusLIMS.schemas package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Previous</span>
    </a>
  </li>
  <li class="dummy-sidebarrel">
    <a><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Next &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><img src="../../../_static/nexusLIMS_bare_logo.png">
<h4><a href="../../../index.html" title="Return to documentation home">
    NexusLIMS Documentation</a></h4>
<ul class="globaltoc">
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Package introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../database.html">NexusLIMS database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../record_building.html">Record building workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../taxonomy.html">NexusLIMS taxonomy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../schema_documentation.html">Schema documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../customizing_cdcs.html">Tips for customizing CDCS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../session_logger_app.html">Session logging (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API documentation</a></li>
</ul>

</ul><h4>
    <a class="no-hover">Page content</a>
</h4>


<form action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  <h1>Source code for nexusLIMS.extractors.digital_micrograph</h1><div class="highlight"><pre>
<span></span><span class="c1">#  NIST Public License - 2019</span>
<span class="c1">#</span>
<span class="c1">#  This software was developed by employees of the National Institute of</span>
<span class="c1">#  Standards and Technology (NIST), an agency of the Federal Government</span>
<span class="c1">#  and is being made available as a public service. Pursuant to title 17</span>
<span class="c1">#  United States Code Section 105, works of NIST employees are not subject</span>
<span class="c1">#  to copyright protection in the United States.  This software may be</span>
<span class="c1">#  subject to foreign copyright.  Permission in the United States and in</span>
<span class="c1">#  foreign countries, to the extent that NIST may hold copyright, to use,</span>
<span class="c1">#  copy, modify, create derivative works, and distribute this software and</span>
<span class="c1">#  its documentation without fee is hereby granted on a non-exclusive basis,</span>
<span class="c1">#  provided that this notice and disclaimer of warranty appears in all copies.</span>
<span class="c1">#</span>
<span class="c1">#  THE SOFTWARE IS PROVIDED &#39;AS IS&#39; WITHOUT ANY WARRANTY OF ANY KIND,</span>
<span class="c1">#  EITHER EXPRESSED, IMPLIED, OR STATUTORY, INCLUDING, BUT NOT LIMITED</span>
<span class="c1">#  TO, ANY WARRANTY THAT THE SOFTWARE WILL CONFORM TO SPECIFICATIONS, ANY</span>
<span class="c1">#  IMPLIED WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE,</span>
<span class="c1">#  AND FREEDOM FROM INFRINGEMENT, AND ANY WARRANTY THAT THE DOCUMENTATION</span>
<span class="c1">#  WILL CONFORM TO THE SOFTWARE, OR ANY WARRANTY THAT THE SOFTWARE WILL BE</span>
<span class="c1">#  ERROR FREE.  IN NO EVENT SHALL NIST BE LIABLE FOR ANY DAMAGES, INCLUDING,</span>
<span class="c1">#  BUT NOT LIMITED TO, DIRECT, INDIRECT, SPECIAL OR CONSEQUENTIAL DAMAGES,</span>
<span class="c1">#  ARISING OUT OF, RESULTING FROM, OR IN ANY WAY CONNECTED WITH THIS SOFTWARE,</span>
<span class="c1">#  WHETHER OR NOT BASED UPON WARRANTY, CONTRACT, TORT, OR OTHERWISE, WHETHER</span>
<span class="c1">#  OR NOT INJURY WAS SUSTAINED BY PERSONS OR PROPERTY OR OTHERWISE, AND</span>
<span class="c1">#  WHETHER OR NOT LOSS WAS SUSTAINED FROM, OR AROSE OUT OF THE RESULTS OF,</span>
<span class="c1">#  OR USE OF, THE SOFTWARE OR SERVICES PROVIDED HEREUNDER.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">re</span> <span class="k">as</span> <span class="nn">_re</span>
<span class="kn">import</span> <span class="nn">logging</span> <span class="k">as</span> <span class="nn">_logging</span>
<span class="kn">import</span> <span class="nn">shutil</span> <span class="k">as</span> <span class="nn">_shutil</span>
<span class="kn">import</span> <span class="nn">tarfile</span> <span class="k">as</span> <span class="nn">_tarfile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">_dt</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span> <span class="k">as</span> <span class="n">_Decimal</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">InvalidOperation</span> <span class="k">as</span> <span class="n">_invalidOp</span>

<span class="kn">from</span> <span class="nn">hyperspy.io</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">_hs_load</span>
<span class="kn">from</span> <span class="nn">hyperspy.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">hyperspy.io_plugins.digital_micrograph</span> <span class="kn">import</span> \
    <span class="n">DigitalMicrographReader</span> <span class="k">as</span> <span class="n">_DMReader</span>
<span class="kn">from</span> <span class="nn">hyperspy.io_plugins.digital_micrograph</span> <span class="kn">import</span> <span class="n">ImageObject</span> <span class="k">as</span> <span class="n">_ImageObject</span>

<span class="kn">from</span> <span class="nn">nexusLIMS.instruments</span> <span class="kn">import</span> <span class="n">get_instr_from_filepath</span> <span class="k">as</span> <span class="n">_get_instr</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">get_nested_dict_key</span> <span class="k">as</span> <span class="n">_get_nest_dict_key</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">get_nested_dict_value_by_path</span> <span class="k">as</span> \
    <span class="n">_get_nest_dict_val_by_path</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">set_nested_dict_value</span> <span class="k">as</span> <span class="n">_set_nest_dict_val</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">try_getting_dict_value</span> <span class="k">as</span> <span class="n">_try_get_dict_val</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">_sort_dict</span>
<span class="kn">from</span> <span class="nn">nexusLIMS.utils</span> <span class="kn">import</span> <span class="n">_remove_dtb_element</span>

<span class="kn">from</span> <span class="nn">struct</span> <span class="kn">import</span> <span class="n">error</span> <span class="k">as</span> <span class="n">_struct_error</span>

<span class="c1"># from hyperspy.misc.utils import DictionaryTreeBrowser as _DTB</span>
<span class="n">_logger</span> <span class="o">=</span> <span class="n">_logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_dm3_metadata"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.get_dm3_metadata">[docs]</a><span class="k">def</span> <span class="nf">get_dm3_metadata</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the metadata (as a dict) from a .dm3 file saved by the Gatan&#39;s</span>
<span class="sd">    Digital Micrograph in the Nexus Microscopy Facility, with some</span>
<span class="sd">    non-relevant information stripped out, and instrument specific metadata</span>
<span class="sd">    parsed and added by one of the instrument-specific parsers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        path to a .dm3 file saved by Gatan&#39;s Digital Micrograph</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    metadata : dict or None</span>
<span class="sd">        The metadata of interest extracted from the file. If None, the file</span>
<span class="sd">        could not be opened</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We do lazy loading so we don&#39;t actually read the data from the disk to</span>
    <span class="c1"># save time and memory.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_hs_load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">DM3DataTypeError</span><span class="p">,</span> <span class="n">DM3FileVersionError</span><span class="p">,</span> <span class="n">DM3TagError</span><span class="p">,</span>
            <span class="n">DM3TagIDError</span><span class="p">,</span> <span class="n">DM3TagTypeError</span><span class="p">,</span> <span class="n">_struct_error</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File reader could not open </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">, received &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;exception: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># s is a list, rather than a single signal</span>
        <span class="n">m_list</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">original_metadata</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">m_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">original_metadata</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m_tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_list</span><span class="p">):</span>
        <span class="c1"># Important trees:</span>
        <span class="c1">#   DocumentObjectList</span>
        <span class="c1">#     Contains information about the display of the information,</span>
        <span class="c1">#     including bits about annotations that are included on top of the</span>
        <span class="c1">#     image data, the CLUT (color look-up table), data min/max.</span>
        <span class="c1">#</span>
        <span class="c1">#   ImageList</span>
        <span class="c1">#     Contains the actual image information</span>

        <span class="c1"># Remove the trees that are not of interest:</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ApplicationBounds&#39;</span><span class="p">,</span> <span class="s1">&#39;LayoutType&#39;</span><span class="p">,</span> <span class="s1">&#39;DocumentTags&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;HasWindowPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageSourceList&#39;</span><span class="p">,</span>  <span class="s1">&#39;Image_Behavior&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;InImageMode&#39;</span><span class="p">,</span> <span class="s1">&#39;MinVersionList&#39;</span><span class="p">,</span> <span class="s1">&#39;NextDocumentObjectID&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;PageSetup&#39;</span><span class="p">,</span> <span class="s1">&#39;Page_Behavior&#39;</span><span class="p">,</span> <span class="s1">&#39;SentinelList&#39;</span><span class="p">,</span> <span class="s1">&#39;Thumbnails&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;WindowPosition&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">]:</span>
            <span class="n">m_tree</span> <span class="o">=</span> <span class="n">_remove_dtb_element</span><span class="p">(</span><span class="n">m_tree</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># Within the DocumentObjectList tree, we really only care about the</span>
        <span class="c1"># AnnotationGroupList for each TagGroup, so go into each TagGroup and</span>
        <span class="c1"># delete everything but that...</span>
        <span class="c1"># NB: the hyperspy DictionaryTreeBrowser __iter__ function returns each</span>
        <span class="c1">#   tree element as a tuple containing the tree name and the actual</span>
        <span class="c1">#   tree, so we loop through the tag names by taking the first part</span>
        <span class="c1">#   of the tuple:</span>
        <span class="k">for</span> <span class="n">tg_name</span><span class="p">,</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">DocumentObjectList</span><span class="p">:</span>
            <span class="c1"># tg_name should be &#39;TagGroup0&#39;, &#39;TagGroup1&#39;, etc.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="c1"># we want to keep this, so remove from the list to loop through</span>
            <span class="k">if</span> <span class="s1">&#39;AnnotationGroupList&#39;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;AnnotationGroupList&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="c1"># k should be in [&#39;AnnotationType&#39;, &#39;BackgroundColor&#39;,</span>
                <span class="c1"># &#39;BackgroundMode&#39;, &#39;FillMode&#39;, etc.]</span>
                <span class="n">m_tree</span> <span class="o">=</span> <span class="n">_remove_dtb_element</span><span class="p">(</span><span class="n">m_tree</span><span class="p">,</span> <span class="s1">&#39;DocumentObjectList.&#39;</span>
                                                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tg_name</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">tg_name</span><span class="p">,</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">ImageList</span><span class="p">:</span>
            <span class="c1"># tg_name should be &#39;TagGroup0&#39;, &#39;TagGroup1&#39;, etc.</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="c1"># We want to keep &#39;ImageTags&#39; and &#39;Name&#39;, so remove from list</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;ImageTags&#39;</span><span class="p">)</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="c1"># k should be in [&#39;ImageData&#39;, &#39;UniqueID&#39;]</span>
                <span class="n">m_tree</span> <span class="o">=</span> <span class="n">_remove_dtb_element</span><span class="p">(</span><span class="n">m_tree</span><span class="p">,</span> <span class="s1">&#39;ImageList.&#39;</span>
                                                     <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tg_name</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_tree</span><span class="o">.</span><span class="n">as_dictionary</span><span class="p">()</span>

        <span class="c1"># Get the instrument object associated with this file</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">_get_instr</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># get the modification time (as ISO format):</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">mtime_iso</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="c1"># if we found the instrument, then store the name as string, else None</span>
        <span class="n">instr_name</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">instr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="c1"># set type to Image by default</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Image&#39;</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_Imaging&#39;</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Creation Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime_iso</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Instrument ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr_name</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_microscope_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_eels_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_eds_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parse_dm3_spectrum_image_info</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># if the instrument name is None, this check will be false, otherwise</span>
        <span class="c1"># look for the instrument in our list of instrument-specific parsers:</span>
        <span class="k">if</span> <span class="n">instr_name</span> <span class="ow">in</span> <span class="n">_instr_specific_parsers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_instr_specific_parsers</span><span class="p">[</span><span class="n">instr_name</span><span class="p">](</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># we don&#39;t need to save the filename, it&#39;s just for internal processing</span>
        <span class="k">del</span> <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span>

        <span class="c1"># sort the nx_meta dictionary (recursively) for nicer display</span>
        <span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sort_dict</span><span class="p">(</span><span class="n">m_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">])</span>


    <span class="c1"># if len(m_list) == 1:</span>
    <span class="c1">#     return m_list[0]</span>
    <span class="c1"># else:</span>
    <span class="c1">#     m_list_dict = {}</span>
    <span class="c1">#     for i in range(len(m_list)):</span>
    <span class="c1">#         m_list_dict[f&#39;Signal {i}&#39;] = m_list[i]</span>
    <span class="c1">#     return m_list_dict</span>

    <span class="c1"># return the first dictionary, which should contain the most information:</span>
    <span class="k">return</span> <span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="parse_643_titan"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_643_titan">[docs]</a><span class="k">def</span> <span class="nf">parse_643_titan</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 643 FEI Titan</span>
<span class="sd">    (&#39;`FEI-Titan-STEM-630901 in 217/F109`&#39;) to the metadata dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The 643 Titan will likely have session info defined, but it may not be</span>
    <span class="c1"># accurate, so add it to the warning list</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Detector&#39;</span><span class="p">,</span> <span class="s1">&#39;Operator&#39;</span><span class="p">,</span> <span class="s1">&#39;Specimen&#39;</span><span class="p">]:</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span><span class="p">])</span>

    <span class="c1"># the 643Titan sets the Imaging mode to &quot;EFTEM DIFFRACTION&quot; when an</span>
    <span class="c1"># actual diffraction pattern is taken</span>
    <span class="k">if</span> <span class="s1">&#39;Imaging Mode&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Imaging Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EFTEM DIFFRACTION&#39;</span><span class="p">:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Diffraction&#39;</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_EFTEM_Diffraction&#39;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_642_titan"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_642_titan">[docs]</a><span class="k">def</span> <span class="nf">parse_642_titan</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 642 FEI Titan</span>
<span class="sd">    (&#39;`FEI-Titan-TEM-635816 in 223/B115`&#39;) to the metadata dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># DONE: complete 642 titan metadata parsing including Tecnai tag</span>
    <span class="n">path_to_tecnai</span> <span class="o">=</span> <span class="n">_get_nest_dict_key</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="s1">&#39;Tecnai&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path_to_tecnai</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># For whatever reason, the expected Tecnai Tag is not present,</span>
        <span class="c1"># so return to prevent errors below</span>
        <span class="k">return</span> <span class="n">mdict</span>

    <span class="n">tecnai_value</span> <span class="o">=</span> <span class="n">_get_nest_dict_val_by_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path_to_tecnai</span><span class="p">)</span>
    <span class="n">microscope_info</span> <span class="o">=</span> <span class="n">tecnai_value</span><span class="p">[</span><span class="s1">&#39;Microscope Info&#39;</span><span class="p">]</span>
    <span class="n">tecnai_value</span><span class="p">[</span><span class="s1">&#39;Microscope Info&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">process_tecnai_microscope_info</span><span class="p">(</span><span class="n">microscope_info</span><span class="p">)</span>
    <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path_to_tecnai</span><span class="p">,</span> <span class="n">tecnai_value</span><span class="p">)</span>

    <span class="c1"># - Tecnai info:</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Gun_Name&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Extractor_Voltage&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Gun_Lens_No&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Emission_Current&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Spot&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Mode&#39;]</span>
    <span class="c1">#     - C2, C3, Obj, Dif lens strength:</span>
    <span class="c1">#         - ImageTags.Tecnai.Microscope_Info[&#39;C2_Strength&#39;,</span>
    <span class="c1">#                                            &#39;C3_Strength&#39;,</span>
    <span class="c1">#                                            &#39;Obj_Strength&#39;,</span>
    <span class="c1">#                                            &#39;Dif_Strength&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Image_Shift_x&#39;/&#39;Image_Shift_y&#39;])</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Stage_Position_x&#39; (y/z/theta/phi)]</span>
    <span class="c1">#     - C1/C2/Objective/SA aperture sizes:</span>
    <span class="c1">#         - ImageTags.Tecnai.Microscope_Info[&#39;(C1/C2/Obj/SA)_Aperture&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Mode&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Dispersion&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Aperture&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Prism_Shift&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][&#39;Drift_Tube&#39;]</span>
    <span class="c1">#     - ImageTags.Tecnai.Microscope_Info[&#39;Filter_Settings&#39;][</span>
    <span class="c1">#           &#39;Total_Energy_Loss&#39;]</span>

    <span class="n">term_mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Gun_Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Gun Name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Extractor_Voltage&#39;</span><span class="p">:</span> <span class="s1">&#39;Extractor Voltage (V)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Camera_Length&#39;</span><span class="p">:</span> <span class="s1">&#39;Camera Length (m)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Gun_Lens_No&#39;</span><span class="p">:</span> <span class="s1">&#39;Gun Lens #&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Emission_Current&#39;</span><span class="p">:</span> <span class="s1">&#39;Emission Current (μA)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Spot&#39;</span><span class="p">:</span> <span class="s1">&#39;Spot&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Mode&#39;</span><span class="p">:</span> <span class="s1">&#39;Tecnai Mode&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Defocus&#39;</span><span class="p">:</span> <span class="s1">&#39;Defocus&#39;</span><span class="p">,</span>
        <span class="s1">&#39;C2_Strength&#39;</span><span class="p">:</span> <span class="s1">&#39;C2 Lens Strength (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;C3_Strength&#39;</span><span class="p">:</span> <span class="s1">&#39;C3 Lens Strength (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Obj_Strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Objective Lens Strength (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Dif_Strength&#39;</span><span class="p">:</span> <span class="s1">&#39;Diffraction Lens Strength (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Microscope_Name&#39;</span><span class="p">:</span> <span class="s1">&#39;Tecnai Microscope Name&#39;</span><span class="p">,</span>
        <span class="s1">&#39;User&#39;</span><span class="p">:</span> <span class="s1">&#39;Tecnai User&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Image_Shift_x&#39;</span><span class="p">:</span> <span class="s1">&#39;Image Shift X (μm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Image_Shift_y&#39;</span><span class="p">:</span> <span class="s1">&#39;Image Shift Y (μm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Stage_Position_x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;X (μm)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Stage_Position_y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Y (μm)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Stage_Position_z&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Z (μm)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Stage_Position_theta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;θ (°)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Stage_Position_phi&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;φ (°)&#39;</span><span class="p">],</span>
        <span class="s1">&#39;C1_Aperture&#39;</span><span class="p">:</span> <span class="s1">&#39;C1 Aperture (μm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;C2_Aperture&#39;</span><span class="p">:</span> <span class="s1">&#39;C2 Aperture (μm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Obj_Aperture&#39;</span><span class="p">:</span> <span class="s1">&#39;Objective Aperture (μm)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SA_Aperture&#39;</span><span class="p">:</span> <span class="s1">&#39;Selected Area Aperture (μm)&#39;</span><span class="p">,</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Mode&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Mode&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Dispersion&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;Dispersion (eV/channel)&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Aperture&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Aperture (mm)&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Prism_Shift&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;Prism Shift (eV)&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Drift_Tube&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Drift Tube (eV)&#39;</span><span class="p">],</span>
        <span class="p">(</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">,</span> <span class="s1">&#39;Total_Energy_Loss&#39;</span><span class="p">):</span> <span class="p">[</span><span class="s1">&#39;Tecnai Filter&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;Total Energy Loss (eV)&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">in_term</span> <span class="ow">in</span> <span class="n">term_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path_to_tecnai</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Microscope Info&#39;</span><span class="p">]</span>
        <span class="n">out_term</span> <span class="o">=</span> <span class="n">term_mapping</span><span class="p">[</span><span class="n">in_term</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_term</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">in_term</span> <span class="o">=</span> <span class="p">[</span><span class="n">in_term</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_term</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">in_term</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">in_term</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_term</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">out_term</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_term</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">in_term</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DO NOT EDIT&#39;</span><span class="p">,</span> <span class="s1">&#39;DO NOT ENTER&#39;</span><span class="p">]:</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">out_term</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">path_to_tecnai</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Specimen Info&#39;</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> \
            <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;Specimen information is not available yet&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Specimen&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># If `Tecnai Mode` is `STEM nP SA Zoom Diffraction`, it&#39;s diffraction</span>
    <span class="k">if</span> <span class="s1">&#39;Tecnai Mode&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="ow">and</span> \
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Tecnai Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;STEM nP SA Zoom Diffraction&#39;</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected file as Diffraction type based on &quot;Tecnai &#39;</span>
                     <span class="s1">&#39;Mode&quot; == &quot;STEM nP SA Zoom Diffraction&quot;&#39;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Diffraction&#39;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STEM_Diffraction&#39;</span>

    <span class="c1"># also, if `Operation Mode` is `DIFFRACTION`, it&#39;s diffraction</span>
    <span class="k">elif</span> <span class="s1">&#39;Operation Mode&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="ow">and</span> \
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Operation Mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DIFFRACTION&#39;</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected file as Diffraction type based on &quot;Operation &#39;</span>
                     <span class="s1">&#39;Mode&quot; == &quot;DIFFRACTION&quot;&#39;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Diffraction&#39;</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_Diffraction&#39;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_642_jeol"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_642_jeol">[docs]</a><span class="k">def</span> <span class="nf">parse_642_jeol</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add/adjust metadata specific to the 642 FEI Titan</span>
<span class="sd">    (&#39;`JEOL-JEM3010-TEM-565989 in 223/A132`&#39;) to the metadata dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        &quot;raw&quot; metadata dictionary as parsed by :py:func:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The original metadata dictionary with added information specific to</span>
<span class="sd">        files originating from this microscope with &quot;important&quot; values contained</span>
<span class="sd">        under the ``nx_meta`` key at the root level</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Currently, the Stroboscope does not add any metadata items that need to</span>
    <span class="c1"># be processed differently than the &quot;default&quot; dm3 tags (and it barely has</span>
    <span class="c1"># any metadata anyway), so this method does not need to do anything</span>

    <span class="c1"># To try to detect diffraction pattern, we will check the file name</span>
    <span class="c1"># against commonly used terms for saving diffraction patterns (not even</span>
    <span class="c1"># close to perfect, but at least it&#39;s something)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Diff&#39;</span><span class="p">,</span> <span class="s1">&#39;SAED&#39;</span><span class="p">,</span> <span class="s1">&#39;DP&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;fname&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                <span class="n">s</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;fname&#39;</span><span class="p">]:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detected file as Diffraction type based on &quot;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&quot; in &#39;</span>
                         <span class="sa">f</span><span class="s1">&#39;the filename&#39;</span><span class="p">)</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Diffraction&#39;</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_Diffraction&#39;</span>

    <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">])</span>
    <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;Data Type&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<span class="n">_instr_specific_parsers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;FEI-Titan-STEM-630901_n&#39;</span><span class="p">:</span> <span class="n">parse_643_titan</span><span class="p">,</span>
    <span class="s1">&#39;FEI-Titan-TEM-635816_n&#39;</span><span class="p">:</span> <span class="n">parse_642_titan</span><span class="p">,</span>
    <span class="s1">&#39;JEOL-JEM3010-TEM-565989_n&#39;</span><span class="p">:</span> <span class="n">parse_642_jeol</span>
<span class="p">}</span>


<div class="viewcode-block" id="get_pre_path"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.get_pre_path">[docs]</a><span class="k">def</span> <span class="nf">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the path into a dictionary where the important DigitalMicrograph</span>
<span class="sd">    metadata is expected to be found. If the .dm3/.dm4 file contains a stack</span>
<span class="sd">    of images, the important metadata for NexusLIMS is not at its usual place</span>
<span class="sd">    and is instead under a `plan info` tag, so this method will determine if the</span>
<span class="sd">    stack metadata is present and return the correct path. ``pre_path`` will</span>
<span class="sd">    be something like ``[&#39;ImageList&#39;, &#39;TagGroup0&#39;, &#39;ImageTags&#39;, &#39;plane</span>
<span class="sd">    info&#39;, &#39;TagGroup0&#39;, &#39;source tags&#39;]``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pre_path : list</span>
<span class="sd">        A list containing the subsequent keys that need to be traversed to</span>
<span class="sd">        get to the point in the `mdict` where the important metadata is stored</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># test if we have a stack</span>
    <span class="n">stack_val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ImageList&#39;</span><span class="p">,</span> <span class="s1">&#39;TagGroup0&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;ImageTags&#39;</span><span class="p">,</span> <span class="s1">&#39;plane info&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">stack_val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="c1"># we&#39;re in a stack</span>
        <span class="n">pre_path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ImageList&#39;</span><span class="p">,</span> <span class="s1">&#39;TagGroup0&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageTags&#39;</span><span class="p">,</span> <span class="s1">&#39;plane info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TagGroup0&#39;</span><span class="p">,</span> <span class="s1">&#39;source tags&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pre_path</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ImageList&#39;</span><span class="p">,</span> <span class="s1">&#39;TagGroup0&#39;</span><span class="p">,</span> <span class="s1">&#39;ImageTags&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">pre_path</span></div>


<div class="viewcode-block" id="parse_dm3_microscope_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_microscope_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_microscope_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the &quot;important&quot; metadata that is saved at specific places within</span>
<span class="sd">    the DM3 tag structure into a consistent place in the metadata dictionary</span>
<span class="sd">    returned by :py:meth:`get_dm3_metadata`. Specifically looks at the</span>
<span class="sd">    &quot;Microscope Info&quot;, &quot;Session Info&quot;, and &quot;Meta Data&quot; nodes of the tag</span>
<span class="sd">    structure (these are not present on every microscope)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The same metadata dictionary with some values added under the</span>
<span class="sd">        root-level ``nx_meta`` key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;nx_meta&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">:</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># General &quot;microscope info&quot; .dm3 tags (not present on all instruments):</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Indicated Magnification&#39;</span><span class="p">,</span> <span class="s1">&#39;Actual Magnification&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs(mm)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;STEM Camera Length&#39;</span><span class="p">,</span> <span class="s1">&#39;Voltage&#39;</span><span class="p">,</span> <span class="s1">&#39;Operation Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Specimen&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Microscope&#39;</span><span class="p">,</span> <span class="s1">&#39;Operator&#39;</span><span class="p">,</span> <span class="s1">&#39;Imaging Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Illumination Mode&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Field of View (</span><span class="se">\u00b5</span><span class="s1">m)&#39;</span><span class="p">,</span> <span class="s1">&#39;Facility&#39;</span><span class="p">,</span>
              <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage Alpha&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage Beta&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage X&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage Y&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Stage Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage Z&#39;</span><span class="p">]]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Microscope Info&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not one of</span>
        <span class="c1"># the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DO NOT EDIT&#39;</span><span class="p">,</span> <span class="s1">&#39;DO NOT ENTER&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># change output of &quot;Stage Position&quot; to unicode characters</span>
            <span class="k">if</span> <span class="s1">&#39;Stage Position&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;Alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;α&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;Beta&#39;</span><span class="p">,</span> <span class="s1">&#39;β&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;Stage &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># General &quot;session info&quot; .dm3 tags (sometimes this information is stored</span>
    <span class="c1"># here instead of under &quot;Microscope Info&quot;:</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Detector&#39;</span><span class="p">,</span> <span class="s1">&#39;Microscope&#39;</span><span class="p">,</span> <span class="s1">&#39;Operator&#39;</span><span class="p">,</span> <span class="s1">&#39;Specimen&#39;</span><span class="p">]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Session Info&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DO NOT EDIT&#39;</span><span class="p">,</span> <span class="s1">&#39;DO NOT ENTER&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># General &quot;Meta Data&quot; .dm3 tags</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Acquisition Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Format&#39;</span><span class="p">,</span> <span class="s1">&#39;Signal&#39;</span><span class="p">,</span>
              <span class="c1"># this one is seen sometimes in EDS signals:</span>
              <span class="p">[</span><span class="s1">&#39;Experiment keywords&#39;</span><span class="p">,</span> <span class="s1">&#39;TagGroup1&#39;</span><span class="p">,</span> <span class="s1">&#39;Label&#39;</span><span class="p">]]:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Meta Data&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DO NOT EDIT&#39;</span><span class="p">,</span> <span class="s1">&#39;DO NOT ENTER&#39;</span><span class="p">]</span> \
                <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="s1">&#39;Label&#39;</span> <span class="ow">in</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Analytic Label&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]</span> <span class="o">+</span>
                                   <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Analytic </span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">m</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Get acquisition device name:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                            <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;DataBar&#39;</span><span class="p">,</span> <span class="s1">&#39;Device Name&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Acquisition Device&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Get exposure time:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span>
                            <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Parameters&#39;</span><span class="p">,</span> <span class="s1">&#39;High Level&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Exposure (s)&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;DataBar&#39;</span><span class="p">,</span> <span class="s1">&#39;Exposure Time (s)&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Exposure Time (s)&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Get GMS version:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span>
                            <span class="p">[</span><span class="s1">&#39;GMS Version&#39;</span><span class="p">,</span> <span class="s1">&#39;Created&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;GMS Version&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Get camera binning:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span>
                            <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Parameters&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;High Level&#39;</span><span class="p">,</span> <span class="s1">&#39;Binning&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Binning (Horizontal)&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Binning (Vertical)&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Get image processing:</span>
    <span class="c1">#   ImageTags.Acquisition.Parameters[&quot;High Level&quot;].Processing will be</span>
    <span class="c1">#   something like &quot;Gain normalized&quot; - not just for EELS so move this to</span>
    <span class="c1">#   general</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Parameters&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;High Level&#39;</span><span class="p">,</span> <span class="s1">&#39;Processing&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Camera/Detector Processing&#39;</span><span class="p">],</span>
                           <span class="n">val</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;Illumination Mode&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s1">&#39;STEM&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Illumination Mode&#39;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STEM_Imaging&#39;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_dm3_eels_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_eels_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_eels_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses metadata from the DigitalMicrograph tag structure that concerns any</span>
<span class="sd">    EELS acquisition or spectrometer settings, placing it in an ``EELS``</span>
<span class="sd">    dictionary underneath the root-level ``nx_meta`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dictionary with all the &quot;EELS-specific&quot; metadata added as</span>
<span class="sd">        sub-node under the ``nx_meta`` root level dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># EELS .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EELS&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Exposure (s)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Integration time (s)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Number of frames&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s2">&quot;Experimental Conditions&quot;</span><span class="p">,</span> <span class="s2">&quot;Collection semi-angle (mrad)&quot;</span><span class="p">],</span>
              <span class="p">[</span><span class="s2">&quot;Experimental Conditions&quot;</span><span class="p">,</span> <span class="s2">&quot;Convergence semi-angle (mrad)&quot;</span><span class="p">]]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
            <span class="c1"># add last value of each parameter to the &quot;EELS&quot; sub-tree of nx_meta</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># different instruments have the spectrometer information in different</span>
    <span class="c1"># places...</span>
    <span class="k">if</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Instrument ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FEI-Titan-TEM-635816_n&#39;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EELS&#39;</span><span class="p">,</span> <span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectrometer&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Instrument ID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FEI-Titan-STEM-630901_n&#39;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EELS Spectrometer&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Aperture label&quot;</span><span class="p">,</span> <span class="s2">&quot;Dispersion (eV/ch)&quot;</span><span class="p">,</span> <span class="s2">&quot;Energy loss (eV)&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Instrument name&quot;</span><span class="p">,</span> <span class="s2">&quot;Drift tube enabled&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Drift tube voltage (V)&quot;</span><span class="p">,</span> <span class="s2">&quot;Slit inserted&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Slit width (eV)&quot;</span><span class="p">,</span> <span class="s2">&quot;Prism offset (V)&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Prism offset enabled &quot;</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
                <span class="c1"># add last value of each param to the &quot;EELS&quot; sub-tree of nx_meta</span>
                <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                   <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">]</span> <span class="o">+</span>
                                   <span class="p">[</span><span class="s2">&quot;Spectrometer &quot;</span> <span class="o">+</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                   <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Process known tags under &quot;processing&quot;:</span>
    <span class="c1">#   ImageTags.Processing will be a list of things done (in multiple</span>
    <span class="c1">#   TagGroups) - things like Compute thickness, etc.</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Processing&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># if val is a dict, then there were processing steps applied</span>
        <span class="n">eels_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># k will be TagGroup0, TagGroup1, etc.</span>
            <span class="c1"># v will be dictionaries specifying the process step</span>
            <span class="c1"># AlignSIByPeak, DataPicker, SpectrumCalibrate,</span>
            <span class="c1"># Compute Thickness, Background Removal, Signal Integration</span>
            <span class="n">op</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;Operation&#39;</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;AlignSIByPeak&#39;</span><span class="p">:</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Aligned parent SI By Peak&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Background Removal&#39;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
                    <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                       <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;Background Removal Model&#39;</span><span class="p">],</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;SpectrumCalibrate&#39;</span><span class="p">:</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Calibrated Post-acquisition&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Compute Thickness&#39;</span><span class="p">:</span>
                <span class="n">mdict</span> <span class="o">=</span> <span class="n">_process_thickness_metadata</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EELS&#39;</span><span class="p">])</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;DataPicker&#39;</span><span class="p">:</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Extracted from SI&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s1">&#39;Signal Integration&#39;</span><span class="p">:</span>
                <span class="n">eels_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eels_ops</span><span class="p">:</span>
            <span class="c1"># remove duplicates (convert to set) and sort alphabetically:</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                               <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Processing Steps&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eels_ops</span><span class="p">))))</span>

    <span class="c1"># Set the dataset type to Spectrum if any EELS tags were added</span>
    <span class="k">if</span> <span class="s1">&#39;EELS&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected file as Spectrum type based on presence of &#39;</span>
                     <span class="s1">&#39;EELS metadata&#39;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Spectrum&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;STEM&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Illumination Mode&#39;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STEM_EELS&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_EELS&#39;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<span class="k">def</span> <span class="nf">_process_thickness_metadata</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
    <span class="n">abs_thick</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span>
                                  <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;Absolute&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Measurement&#39;</span><span class="p">])</span>
    <span class="n">abs_units</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span>
                                  <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;Absolute&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Units&#39;</span><span class="p">])</span>
    <span class="n">abs_mfp</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span>
                                <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;Absolute&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Mean Free Path&#39;</span><span class="p">])</span>
    <span class="n">rel_thick</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span>
                                  <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Thickness&#39;</span><span class="p">,</span> <span class="s1">&#39;Relative&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Measurement&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">abs_thick</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">,</span>
                                   <span class="sa">f</span><span class="s1">&#39;Thickness (absolute) [&#39;</span>
                                   <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">abs_units</span><span class="si">}</span><span class="s1">]&#39;</span><span class="p">],</span>
                           <span class="n">abs_thick</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">abs_mfp</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Thickness (absolute) mean &#39;</span>
                                   <span class="s1">&#39;free path&#39;</span><span class="p">],</span> <span class="n">abs_mfp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">rel_thick</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EELS&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Thickness (relative) [t/λ]&#39;</span><span class="p">],</span>
                           <span class="n">rel_thick</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mdict</span>


<div class="viewcode-block" id="parse_dm3_eds_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_eds_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_eds_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses metadata from the DigitalMicrograph tag structure that concerns any</span>
<span class="sd">    EDS acquisition or spectrometer settings, placing it in an ``EDS``</span>
<span class="sd">    dictionary underneath the root-level ``nx_meta`` node. Metadata values</span>
<span class="sd">    that are commonly incorrect or may be placeholders are specified in a</span>
<span class="sd">    list under the ``nx_meta.warnings`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dictionary with all the &quot;EDS-specific&quot; metadata</span>
<span class="sd">        added as sub-node under the ``nx_meta`` root level dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># EELS .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Continuous Mode&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Count Rate Unit&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Dispersion (eV)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy Cutoff (V)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Exposure (s)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Count rate&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Active layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Azimuthal angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Dead layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Detector type&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Elevation angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Fano&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Gold layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Incidence angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Solid angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage tilt&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Window thickness&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Window type&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Zero fwhm&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Live time&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Real time&#39;</span><span class="p">]]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
            <span class="c1"># add last value of each parameter to the &quot;EDS&quot; sub-tree of nx_meta</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EDS&#39;</span><span class="p">]</span> <span class="o">+</span>
                               <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># test to see if the SI attribute is present in the metadata dictionary.</span>
    <span class="c1"># If so, then some of the relevant EDS values are located there, rather</span>
    <span class="c1"># than in the root-level EDS tag (all of the EDS.Acquisition tags from</span>
    <span class="c1"># above)</span>
    <span class="k">if</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SI&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Continuous Mode&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Count Rate Unit&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Dispersion (eV)&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy Cutoff (V)&#39;</span><span class="p">],</span>
                  <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Exposure (s)&#39;</span><span class="p">]]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SI&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
                <span class="c1"># add last value of each parameter to the &quot;EDS&quot; sub-tree of</span>
                <span class="c1"># nx_meta</span>
                <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EDS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">val</span><span class="p">)</span>
        <span class="c1"># for an SI EDS dataset, set &quot;Live time&quot;, &quot;Real time&quot; and &quot;Count rate&quot;</span>
        <span class="c1"># to the averages stored in the ImageList.TagGroup0.ImageTags.EDS.Images</span>
        <span class="c1"># values</span>
        <span class="n">im_dict</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;EDS&#39;</span><span class="p">,</span> <span class="s1">&#39;Images&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">im_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;EDS&#39;</span><span class="p">]:</span>
                    <span class="k">del</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;EDS&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="c1"># this should work for 2D (spectrum image) as well as 1D</span>
                <span class="c1"># (linescan) datasets since DM saves this information as a 1D</span>
                <span class="c1"># list regardless of original data shape</span>
                <span class="n">avg_val</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                   <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;EDS&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> (SI Average)&#39;</span><span class="p">],</span>
                                   <span class="n">avg_val</span><span class="p">)</span>

    <span class="c1"># Add the .dm3 EDS values to the warnings list, since they might not be</span>
    <span class="c1"># accurate</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;Count rate&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Active layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Azimuthal angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Dead layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Detector type&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Elevation angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Fano&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Gold layer&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Incidence angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Solid angle&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Stage tilt&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Window thickness&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Window type&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Detector Info&#39;</span><span class="p">,</span> <span class="s1">&#39;Zero fwhm&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Live time&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Real time&#39;</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;EDS&#39;</span><span class="p">]</span> <span class="o">+</span>
                                                <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="c1"># Set the dataset type to Spectrum if any EDS tags were added</span>
    <span class="k">if</span> <span class="s1">&#39;EDS&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected file as Spectrum type based on presence of &#39;</span>
                     <span class="s1">&#39;EDS metadata&#39;</span><span class="p">)</span>
        <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Spectrum&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;STEM&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Illumination Mode&#39;</span><span class="p">]:</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;STEM_EDS&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no known files match this mode, so skip for coverage</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TEM_EDS&#39;</span>    <span class="c1"># pragma: no cover</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<div class="viewcode-block" id="parse_dm3_spectrum_image_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.parse_dm3_spectrum_image_info">[docs]</a><span class="k">def</span> <span class="nf">parse_dm3_spectrum_image_info</span><span class="p">(</span><span class="n">mdict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses metadata from the DigitalMicrograph tag structure that concerns any</span>
<span class="sd">    spectrum imaging information (from the &quot;SI&quot; tag) and places it in a</span>
<span class="sd">    &quot;Spectrum Imaging&quot; dictionary underneath the root-level ``nx_meta`` node.</span>
<span class="sd">    Metadata values that are commonly incorrect or may be placeholders are</span>
<span class="sd">    specified in a list under the ``nx_meta.warnings`` node.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        A metadata dictionary as returned by :py:meth:`get_dm3_metadata`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    mdict : dict</span>
<span class="sd">        The metadata dictionary with all the &quot;EDS-specific&quot; metadata</span>
<span class="sd">        added as sub-node under the ``nx_meta`` root level dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre_path</span> <span class="o">=</span> <span class="n">get_pre_path</span><span class="p">(</span><span class="n">mdict</span><span class="p">)</span>

    <span class="c1"># Spectrum imaging .dm3 tags of interest:</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">pre_path</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;SI&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">m_in</span><span class="p">,</span> <span class="n">m_out</span> <span class="ow">in</span> \
            <span class="p">[([</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Pixel time (s)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Pixel time (s)&#39;</span><span class="p">]),</span>
             <span class="p">([</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;SI Application Mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Scan Mode&#39;</span><span class="p">]),</span>
             <span class="p">([</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Spatial Sampling&#39;</span><span class="p">,</span> <span class="s1">&#39;Height (pixels)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Spatial Sampling (Vertical)&#39;</span><span class="p">]),</span>
             <span class="p">([</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Spatial Sampling&#39;</span><span class="p">,</span> <span class="s1">&#39;Width (pixels)&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Spatial Sampling (Horizontal)&#39;</span><span class="p">]),</span>
             <span class="p">([</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Scan Options&#39;</span><span class="p">,</span> <span class="s1">&#39;Sub-pixel sampling&#39;</span><span class="p">],</span>
              <span class="p">[</span><span class="s1">&#39;Sub-pixel Sampling Factor&#39;</span><span class="p">])]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">m_in</span><span class="p">)</span>
        <span class="c1"># only add the value to this list if we found it, and it&#39;s not</span>
        <span class="c1"># one of the &quot;facility-wide&quot; set values that do not have any meaning:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
            <span class="c1"># add last value of each parameter to the &quot;EDS&quot; sub-tree of nx_meta</span>
            <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectrum Imaging&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">m_out</span><span class="p">,</span>
                               <span class="n">val</span><span class="p">)</span>

    <span class="c1"># Check spatial drift correction separately:</span>
    <span class="n">drift_per_val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                      <span class="n">base</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;Artefact Correction&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;Spatial Drift&#39;</span><span class="p">,</span> <span class="s1">&#39;Periodicity&#39;</span><span class="p">])</span>
    <span class="n">drift_unit_val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                                       <span class="n">base</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;Artefact Correction&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;Spatial Drift&#39;</span><span class="p">,</span> <span class="s1">&#39;Units&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">drift_per_val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">drift_unit_val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">val_to_set</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Spatial drift correction every </span><span class="si">{</span><span class="n">drift_per_val</span><span class="si">}</span><span class="s2"> &quot;</span> \
                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">drift_unit_val</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># make sure statement looks gramatically correct</span>
        <span class="k">if</span> <span class="n">drift_per_val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(s)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(s)&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
        <span class="c1"># fix for &quot;seconds(s)&quot; (stupid DM...)</span>
        <span class="k">if</span> <span class="n">val_to_set</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;ss&#39;</span><span class="p">:</span>
            <span class="n">val_to_set</span> <span class="o">=</span> <span class="n">val_to_set</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                           <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectrum Imaging&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Artefact Correction&#39;</span><span class="p">],</span>
                           <span class="n">val_to_set</span><span class="p">)</span>

    <span class="c1"># Calculate acquisition duration:</span>
    <span class="n">start_val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;Start time&#39;</span><span class="p">])</span>
    <span class="n">end_val</span> <span class="o">=</span> <span class="n">_try_get_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;End time&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">start_val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">and</span> <span class="n">end_val</span> <span class="o">!=</span> <span class="s1">&#39;not found&#39;</span><span class="p">:</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_val</span><span class="p">,</span> <span class="s1">&#39;%I:%M:%S %p&#39;</span><span class="p">)</span>
        <span class="n">end_dt</span> <span class="o">=</span> <span class="n">_dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_val</span><span class="p">,</span> <span class="s1">&#39;%I:%M:%S %p&#39;</span><span class="p">)</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_dt</span> <span class="o">-</span> <span class="n">start_dt</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
        <span class="n">_set_nest_dict_val</span><span class="p">(</span><span class="n">mdict</span><span class="p">,</span>
                           <span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">,</span> <span class="s1">&#39;Spectrum Imaging&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;Acquisition Duration (s)&#39;</span><span class="p">],</span> <span class="n">duration</span><span class="p">)</span>

    <span class="c1"># Set the dataset type to SpectrumImage if it is already a Spectrum (</span>
    <span class="c1"># otherwise it&#39;s just a STEM image) and any Spectrum Imaging tags were</span>
    <span class="c1"># added</span>
    <span class="k">if</span> <span class="s1">&#39;Spectrum Imaging&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Spectrum&#39;</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Detected file as SpectrumImage type based on &#39;</span>
                         <span class="s1">&#39;presence of spectral metadata and spectrum imaging &#39;</span>
                         <span class="s1">&#39;info&#39;</span><span class="p">)</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;DatasetType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;SpectrumImage&#39;</span>
            <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Spectrum_Imaging&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;EELS&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
                <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EELS_Spectrum_Imaging&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;EDS&#39;</span> <span class="ow">in</span> <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">]:</span>
                <span class="n">mdict</span><span class="p">[</span><span class="s1">&#39;nx_meta&#39;</span><span class="p">][</span><span class="s1">&#39;Data Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EDS_Spectrum_Imaging&#39;</span>

    <span class="k">return</span> <span class="n">mdict</span></div>


<span class="k">def</span> <span class="nf">_try_decimal</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_Decimal</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">_invalidOp</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">val</span>


<div class="viewcode-block" id="process_tecnai_microscope_info"><a class="viewcode-back" href="../../../api/nexusLIMS.extractors.html#nexusLIMS.extractors.digital_micrograph.process_tecnai_microscope_info">[docs]</a><span class="k">def</span> <span class="nf">process_tecnai_microscope_info</span><span class="p">(</span><span class="n">microscope_info</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\u2028</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the Microscope_Info metadata string from an FEI Titan</span>
<span class="sd">    TEM into a dictionary of key-value pairs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    microscope_info : str</span>
<span class="sd">        The string of data obtained from the original_metadata.ImageList.\</span>
<span class="sd">        TagGroup0.ImageTags.Tecnai.Microscope_Info leaf of the metadata tree</span>
<span class="sd">        obtained when loading a .dm3 file as a HyperSpy signal</span>
<span class="sd">    delimiter : str</span>
<span class="sd">        The value (a unicode string) used to split the ``microscope_info``</span>
<span class="sd">        string. Should not need to be provided (this value is hard-coded in</span>
<span class="sd">        DigitalMicrograph), but specified as a parameter for future</span>
<span class="sd">        flexibility</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    info_dict : dict</span>
<span class="sd">        The information contained in the string, in a more easily-digestible</span>
<span class="sd">        form.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__find_val</span><span class="p">(</span><span class="n">s_to_find</span><span class="p">,</span> <span class="n">list_to_search</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the first value in list_to_search that contains s_to_find, or</span>
<span class="sd">        None if it is not found</span>

<span class="sd">        Note: If needed, this could be improved to use regex instead, which</span>
<span class="sd">              would provide more control over the patterns to return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">list_to_search</span> <span class="k">if</span> <span class="n">s_to_find</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># remove the string we searched for from the beginning of the res</span>
            <span class="k">return</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">s_to_find</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">info_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># split the string into a list</span>
    <span class="n">tecnai_info</span> <span class="o">=</span> <span class="n">microscope_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>

    <span class="c1"># String</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Microscope_Name&#39;</span><span class="p">]</span> <span class="o">=</span> \
        <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Microscope &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>

    <span class="c1"># String</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;User&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;User &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>

    <span class="c1"># String</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Gun &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Gun_Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39; Extr volt&#39;</span><span class="p">)]</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Gun_Name&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Gun_Name&#39;</span><span class="p">]):]</span>

    <span class="c1"># Integer (volts)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;Extr volt &#39;</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Extractor_Voltage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Integer</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Gun Lens &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Gun Lens &#39;</span><span class="p">):]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Gun_Lens_No&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Decimal (microAmps)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Emission &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Emission &#39;</span><span class="p">):]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Emission_Current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;uA&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># String</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Mode &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39; Defocus&#39;</span><span class="p">)]</span>
    <span class="c1"># &#39;Mode&#39; should be five terms long, and the last term is either &#39;Image&#39;,</span>
    <span class="c1"># &#39;Diffraction&#39;, (or maybe something else)</span>

    <span class="c1"># Decimal (micrometer)</span>
    <span class="k">if</span> <span class="s1">&#39;Magn &#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>  <span class="c1"># Imaging mode</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Defocus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Defocus (um) &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="s1">&#39;CL &#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>  <span class="c1"># Diffraction mode</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Defocus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Defocus &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># This value changes based on whether in image or diffraction mode</span>
    <span class="c1"># (magnification or camera length)</span>
    <span class="c1"># Integer</span>
    <span class="k">if</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Image&#39;</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Magnification&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Magn &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>
    <span class="c1"># Decimal</span>
    <span class="k">elif</span> <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Mode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Diffraction&#39;</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Camera_Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;CL &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">))</span>

    <span class="c1"># Integer (1 to 5)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Spot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Spot &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">))</span>

    <span class="c1"># Decimals - Lens strengths expressed as a &quot;%&quot; value</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;C2_Strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
        <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;C2 &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;C3_Strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
        <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;C3 &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Obj_Strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
        <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Obj &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Dif_Strength&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span>
        <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Dif &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">))</span>

    <span class="c1"># Decimals (micrometers)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Image shift &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;um&#39;</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Image_Shift_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Image_Shift_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Decimal values are given in micrometers and degrees</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Stage &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">_try_decimal</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; umdeg&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Stage_Position_x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Stage_Position_y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Stage_Position_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Stage_Position_theta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Stage_Position_phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__read_aperture</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tecnai_info_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method to test if aperture has value or is retracted&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">tecnai_info_</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; um&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># Either an integer value or None (indicating the aperture was not</span>
    <span class="c1"># inserted or tag did not exist in the metadata)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;C1_Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s1">&#39;C1 Aperture: &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;C2_Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s1">&#39;C2 Aperture: &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Obj_Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s1">&#39;OBJ Aperture: &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>
    <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;SA_Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__read_aperture</span><span class="p">(</span><span class="s1">&#39;SA Aperture: &#39;</span><span class="p">,</span> <span class="n">tecnai_info</span><span class="p">)</span>

    <span class="c1"># Nested dictionary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tecnai_filter_info</span> <span class="o">=</span> <span class="n">tecnai_info</span><span class="p">[</span><span class="n">tecnai_info</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
            <span class="s1">&#39;Filter related settings:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="c1"># String</span>
        <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Mode: &#39;</span><span class="p">,</span>
                                                          <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="c1"># Decimal (eV/channel)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Selected dispersion: &#39;</span><span class="p">,</span> <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[eV/Channel\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Dispersion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Decimal (millimeter)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Selected aperture: &#39;</span><span class="p">,</span> <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Aperture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Decimal (eV)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Prism shift: &#39;</span><span class="p">,</span> <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[eV\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Prism_Shift&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Decimal (eV)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Drift tube: &#39;</span><span class="p">,</span> <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[eV\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Drift_Tube&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Decimal (eV)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">__find_val</span><span class="p">(</span><span class="s1">&#39;Total energy loss: &#39;</span><span class="p">,</span> <span class="n">tecnai_filter_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[eV\]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
            <span class="n">info_dict</span><span class="p">[</span><span class="s1">&#39;Filter_Settings&#39;</span><span class="p">][</span><span class="s1">&#39;Total_Energy_Loss&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">_try_decimal</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filter settings not found in Tecnai microscope info&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">info_dict</span></div>


<span class="k">def</span> <span class="nf">_zero_data_in_dm3</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper method that will overwrite the data in a dm3 image file  with</span>
<span class="sd">    zeros and save it as either another dm3, or as a compressed archive (used</span>
<span class="sd">    for creating files for the test suite that don&#39;t take up tons of space).</span>
<span class="sd">    Since the resulting file is just some text metadata and zeros, it should</span>
<span class="sd">    be highly compressible (initial tests allowed for a 16MB file to be</span>
<span class="sd">    compressed to ~100KB).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to file to be modified</span>
<span class="sd">    out_filename : None or str</span>
<span class="sd">        Name with which to save the output file. If None, it will be</span>
<span class="sd">        automatically generated from the ``filename``.</span>
<span class="sd">    compress : bool</span>
<span class="sd">        Whether or not to compress the files into a tar.gz file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out_fname : str</span>
<span class="sd">        The path of the compressed (or zeroed) file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># zero out extent of data in DM3 file and compress to tar.gz:</span>
    <span class="n">splitext</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">out_filename</span><span class="p">:</span>
        <span class="n">mod_fname</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_dataZeroed&#39;</span> <span class="o">+</span> <span class="n">splitext</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mod_fname</span> <span class="o">=</span> <span class="n">out_filename</span>

    <span class="n">_shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mod_fname</span><span class="p">)</span>

    <span class="c1"># Do some lower-level reading on the .dm3 file to get the ImageObject refs</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">_DMReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">dm</span><span class="o">.</span><span class="n">parse_file</span><span class="p">()</span>
        <span class="n">images</span> <span class="o">=</span> <span class="p">[</span><span class="n">_ImageObject</span><span class="p">(</span><span class="n">im_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">im_dict</span> <span class="ow">in</span>
                  <span class="n">dm</span><span class="o">.</span><span class="n">get_image_dictionaries</span><span class="p">()]</span>

    <span class="c1"># write zeros to the file in the data block (offset + size in bytes</span>
    <span class="c1"># information is obtained from the ImageObject ref)</span>
    <span class="c1"># NB: currently this is just tested for single-image .dm3 files. Spectra</span>
    <span class="c1"># and image stacks will probably work differently.</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mod_fname</span><span class="p">,</span> <span class="s1">&#39;r+b&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imdict</span><span class="o">.</span><span class="n">ImageData</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span> <span class="o">*</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imdict</span><span class="o">.</span><span class="n">ImageData</span><span class="o">.</span><span class="n">Data</span><span class="o">.</span><span class="n">size_bytes</span><span class="p">)</span>

    <span class="c1"># compress the output, if requested</span>
    <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">_tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.tar.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mod_fname</span><span class="p">),</span> <span class="s1">&#39;w:gz&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tar</span><span class="p">:</span>
            <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mod_fname</span><span class="p">)</span>
        <span class="n">out_fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.tar.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mod_fname</span><span class="p">)</span>
        <span class="n">_os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">mod_fname</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_fname</span> <span class="o">=</span> <span class="n">mod_fname</span>

    <span class="k">return</span> <span class="n">out_fname</span>
</pre></div>

    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2022, NIST Office of Data and Informatics.<br/>
      Last updated on Jul, 15, 2022.<br/>
    </p>
  </div>
</footer>

  </body>
</html>